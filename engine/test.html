<!DOCTYPE html>
<html>
<head>
	<meta charset="UTF-8">
	<script type="text/javascript" src="script_common_debug.js"></script>
	<script type="text/javascript" src="script_parse.js"></script>
	<script type="text/javascript" src="script_exec.js"></script>
	<style type="text/css">
	.error {color: red;}
	</style>
	<script type="text/javascript">
	function escapeHTML(str) {
		return str.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;').replace(/'/g, '&#39;');
	}
	ScriptExec.lib['error'] = function(ei, param, ret) {
		if (param.length === 0) {
			return -2;
		}
		let str = '';
		if (param[0].v.type === TYPE_ARRAY) {
			str = '{' + arrayToString(param[0].v.array) + '}'
		} else {
			str = ScriptExec.getValueString(param[0].v);
		}
		document.getElementById('result').innerHTML += '<p class="error">' + escapeHTML(str) + '</p>';
		return 0;
	}
	ScriptExec.lib['print'] = function(ei, param, ret) {
		if (param.length === 0) {
			return -2;
		}
		let str = '';
		if (param[0].v.type === TYPE_ARRAY) {
			str = '{' + arrayToString(param[0].v.array) + '}'
		} else {
			str = ScriptExec.getValueString(param[0].v);
		}
		document.getElementById('result').innerHTML += escapeHTML(str).replace(/\\n/, '<br />');
		return 0;
	};
	function arrayToString(array) {
		let ret = '';
		array.forEach(function(a) {
			if (ret) {
				ret = ret + ', ';
			}
			if (a.name) {
				ret += '"' + a.name + '": ';
			}
			if (a.v.type === TYPE_ARRAY) {
				ret += '{' + arrayToString(a.v.array) + '}';
			} else if (a.v.type === TYPE_STRING) {
				ret += '"' + a.v.str + '"';
			} else {
				ret += a.v.num;
			}
		});
		return ret;
	}
	function exec() {
		const buf = document.getElementById('src').value;
		const sci = Script.initScriptInfo();
		scis = [sci];
		_exec(scis, sci, buf, false);
	}
	function _exec(scis, sci, buf, imp) {
		const sp = new ScriptParse(sci);
		try {
			sp.parse(buf, {
				import: function(file) {
					const _buf = document.getElementById('src2').value;
					const _sci = Script.initScriptInfo();
					scis.push(_sci);
					_exec(scis, _sci, _buf, true);
				},
				library: function(file) {
				},
				success: function(token) {
					console.log(token);
					const se = new ScriptExec(scis, sci);
					try {
						se.exec(token, {}, {
							callback: function(ei) {
								//console.log('token=' + ei.token[ei.index].type + ', vi=' + JSON.stringify(ei.vi));
								return 0;
							},
							success: function(value) {
								if (imp) {
									return;
								}
								if (value.type === TYPE_INTEGER || value.type === TYPE_FLOAT) {
									document.getElementById('result').innerHTML += '<p>Result: ' + value.num + '</p><hr />';
								} else if (value.type === TYPE_STRING) {
									document.getElementById('result').innerHTML += '<p>Result: ' + escapeHTML(value.str) + '</p><hr />';
								} else if (value.type === TYPE_ARRAY) {
									document.getElementById('result').innerHTML += '<p>Result: {' + escapeHTML(arrayToString(value.array)) + '}</p><hr />';
								}
							},
							error: function(error) {
								document.getElementById('result').innerHTML += '<p class="error">Exec Error: ' + error.msg + ' (' + (error.line + 1) + ')</p><hr />';
							}
						});
					} catch(e) {
						document.getElementById('result').innerHTML += '<p class="error">Exec Error: ' + e + '</p><hr />';
					}
				},
				error: function(error) {
					document.getElementById('result').innerHTML += '<p class="error">Parse Error: ' + error.msg + ' (' + (error.line + 1) + ')</p><hr />';
				}
			});
		} catch(e) {
			document.getElementById('result').innerHTML += '<p class="error">Parse Error: ' + e + '</p><hr />';
		}
	}
	function clearResult() {
		document.getElementById('result').innerHTML = '';
	}
	</script>
</head>
<body>

<textarea id="src" style="width:350px;height:200px;">
#option("PG0.5")
#import("hoge")

a()
</textarea>
<textarea id="src2" style="width:350px;height:200px;">
#option("PG0.5")

function a() {
print("aaa")
}
</textarea>
<div><input type="button" value="Exec" onclick="exec();"></input> <input type="button" value="Clear" onclick="clearResult();"></input></div>
<div><span id="result"></span></div>

</body>
</html>

